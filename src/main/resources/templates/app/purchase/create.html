<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/index}">
<head>
    <title>Create Purchase</title>
</head>

<body>
<section layout:fragment="content">
    <div class="d-flex flex-wrap justify-content-between align-items-center mt-4 mb-3 gap-2">
        <div>
            <h1 class="fw-bold mb-1 fs-3">Create Purchase</h1>
            <p class="text-muted mb-0 fs-6">Register a new purchase by selecting supplier, store, and adding details.</p>
        </div>
        <form th:action="@{/purchases/create}" method="post" th:object="${purchase}">
            <div class="d-flex justify-content-end gap-2">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-check-circle"></i> Confirm Purchase
                </button>
            </div>
        </form>
    </div>

    <nav>
        <ol class="breadcrumb small mb-4">
            <li class="breadcrumb-item"><a th:href="@{/dashboard}">Dashboard</a></li>
            <li class="breadcrumb-item"><a th:href="@{/purchases}">Purchases</a></li>
            <li class="breadcrumb-item active">Create</li>
        </ol>
    </nav>

    <div class="row g-3 mb-4">
        <form th:action="@{/purchases/create}" method="post" class="col-md-6 d-flex align-items-end" th:object="${purchase}">
            <input type="hidden" name="addSupplier" value="true"/>
            <div class="w-100">
                <label for="supplierId" class="form-label">Supplier</label>
                <select class="form-select" id="supplierId" name="supplierId" onchange="this.form.submit()" required>
                    <option value="">Select Supplier</option>
                    <option th:each="supplier : ${suppliers}"
                            th:value="${supplier.id}"
                            th:text="${supplier.name}"
                            th:selected="${supplier.id == purchase.supplierId}">
                    </option>
                </select>
            </div>
        </form>
        <form th:action="@{/purchases/create}" method="post" class="col-md-6 d-flex align-items-end">
            <input type="hidden" name="addStore" value="true"/>
            <div class="w-100">
                <label for="storeId" class="form-label">Store</label>
                <select class="form-select" id="storeId" name="storeId" onchange="this.form.submit()" required>
                    <option value="">Select Store</option>
                    <option th:each="store : ${stores}"
                            th:value="${store.id}"
                            th:text="${store.ruc}"
                            th:selected="${store.id == purchase.storeId}">
                    </option>
                </select>
            </div>
        </form>
    </div>

    <div class="mb-4">
        <form th:action="@{/purchases/create}" method="post" th:object="${purchaseDetail}" class="row g-3 align-items-end">
            <div class="col-md-3">
                <label for="productStoreId" class="form-label">Store Product</label>
                <select class="form-select" id="productStoreId" th:field="*{productStoreId}" th:errorclass="is-invalid" th:disabled="${purchase.storeId == null}">
                    <option value="">Select Product</option>
                    <option th:each="product : ${products}"
                            th:value="${product.id}"
                            th:text="${product.product.name}"></option>
                </select>
                <div th:if="${#fields.hasErrors('productStoreId')}" th:errors="*{productStoreId}" class="text-danger small"></div>
            </div>
            <div class="col-md-2">
                <label for="quantity" class="form-label">Quantity</label>
                <input type="number" placeholder="Quantity" class="form-control" id="quantity" th:field="*{quantity}" th:errorclass="is-invalid" th:disabled="${purchase.storeId == null}">
                <div th:if="${#fields.hasErrors('quantity')}" th:errors="*{quantity}" class="text-danger small"></div>
            </div>
            <div class="col-md-3">
                <label for="purchasePrice" class="form-label">Purchase Price</label>
                <input type="number" placeholder="Purchase Price" class="form-control" id="purchasePrice" th:field="*{purchasePrice}" th:errorclass="is-invalid" th:disabled="${purchase.storeId == null}">
                <div th:if="${#fields.hasErrors('purchasePrice')}" th:errors="*{purchasePrice}" class="text-danger small"></div>
            </div>
            <div class="col-md-3">
                <label for="salePrice" class="form-label">Sale Price</label>
                <input type="number" placeholder="Sale Price" class="form-control" id="salePrice" th:field="*{salePrice}" th:errorclass="is-invalid" th:disabled="${purchase.storeId == null}">
                <div th:if="${#fields.hasErrors('salePrice')}" th:errors="*{salePrice}" class="text-danger small"></div>
            </div>
            <div class="col-md-1 text-end">
                <button th:disabled="${purchase.storeId == null}" class="btn btn-primary mt-2 w-100" name="addPurchaseDetail">
                    Add
                </button>
            </div>
        </form>
        <div class="table-responsive mt-4">
            <table class="table table-bordered align-middle mb-0">
                <thead class="table-light">
                <tr>
                    <th>#</th>
                    <th>Product Store</th>
                    <th>Quantity</th>
                    <th>Purchase Price</th>
                    <th>Sale Price</th>
                    <th></th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="detail, iterStat : ${purchase.purchaseDetails}">
                    <td th:text="${iterStat.index + 1}"></td>
                    <td th:text="${detail.productStoreId}"></td>
                    <td th:text="${detail.quantity}"></td>
                    <td th:text="${#numbers.formatDecimal(detail.purchasePrice, 1, 'COMMA', 2, 'POINT')}"></td>
                    <td th:text="${#numbers.formatDecimal(detail.salePrice, 1, 'COMMA', 2, 'POINT')}"></td>
                    <td class="text-center">
                        <a th:href="@{'create?removePurchaseDetail&storeProductId=' + ${detail.productStoreId}}" class="btn btn-primary">
                            <i class="fas fa-trash"></i>
                        </a>
                    </td>
                </tr>
                <tr th:if="${#lists.isEmpty(purchase.purchaseDetails)}">
                    <td colspan="6" class="text-center text-muted py-3">No details added yet.</td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div th:if="${validationErrors != null}" class="alert alert-danger">
        <ul class="mb-0">
            <li th:each="error : ${validationErrors}" th:text="${error.propertyPath + ': ' + error.message}"></li>
        </ul>
    </div>
</section>
</body>
</html>
